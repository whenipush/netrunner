package controllers

import (
	"bufio"
	"fmt"
	"log"
	"netrunner/database"
	"netrunner/handlers"
	"netrunner/models"
	"os/exec"
	"regexp"
	"strconv"
	"strings"
	"time"
)

func ExecutePentest(task models.TaskStatus, params PentestParams) error {
	if params.Ports == "" {
		database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("status", StatusError)
		return fmt.Errorf("missing required parameter 'ports'")
	}

	currentTime := time.Now()
	currentDate := currentTime.Format("2006-01-02")
	report := fmt.Sprintf("report/pentest/task%d-%s.xml", task.ID, currentDate)

	ipList := []string{}
	for _, host := range task.Hosts {
		ipList = append(ipList, host.IP)
	}
	ip := strings.Join(ipList, " ")
	if ip == "" {
		return fmt.Errorf("no valid hosts specified")
	}

	command := fmt.Sprintf("nmap --script vuln --stats-every 5s -p %s -T%s %s -oX %s", params.Ports, params.Speed, ip, report)
	cmd := exec.Command("powershell", "-Command", command)

	stdout, err := cmd.StdoutPipe()
	if err != nil {
		database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("status", StatusError)
		return fmt.Errorf("failed to get stdout pipe: %v", err)
	}
	defer stdout.Close()

	stderr, err := cmd.StderrPipe()
	if err != nil {
		database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("status", StatusError)
		return fmt.Errorf("failed to get stderr pipe: %v", err)
	}
	defer stderr.Close()

	if err := cmd.Start(); err != nil {
		database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("status", StatusError)
		return fmt.Errorf("failed to start Pentest command: %v", err)
	}

	progressRegex := regexp.MustCompile(`About (\d+(\.\d+)?)% done`)
	go func() {
		scanner := bufio.NewScanner(stdout)
		for scanner.Scan() {
			line := scanner.Text()
			log.Printf("[Pentest]: %s", line)

			if matches := progressRegex.FindStringSubmatch(line); matches != nil {
				percent := matches[1]
				percentValue, _ := strconv.ParseFloat(percent, 32)
				task.Percent = float32(percentValue)
				database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("percent", percentValue)
				BroadcastTask(task)
			}
		}
	}()

	go func() {
		scanner := bufio.NewScanner(stderr)
		for scanner.Scan() {
			log.Printf("[Pentest STDERR]: %s", scanner.Text())
		}
	}()

	if err := cmd.Wait(); err != nil {
		database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("status", StatusError)
		return fmt.Errorf("pentest execution failed: %v", err)
	}

	// Обработка отчета
	_, err = handlers.ProcessPentest(report, report+".json")
	if err != nil {
		database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Update("status", StatusError)
		return fmt.Errorf("failed to process Pentest report: %v", err)
	}

	database.DB.Model(&models.TaskStatus{}).Where("id = ?", task.ID).Updates(map[string]interface{}{
		"status":  StatusCompleted,
		"percent": 100,
	})
	task.Status = StatusCompleted
	task.Percent = 100
	BroadcastTask(task)

	return nil
}
